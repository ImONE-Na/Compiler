name: ğŸ—ï¸ Lineage Kernel Compilation ğŸ‰

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Kernel Building ...

    steps:
      # Step 1: Display ASCII Art for Workflow Start
      - name: ğŸ¨ Display Workflow Start Art
        run: |
          echo "ğŸš€ Starting Lineage Kernel Compilation! ğŸš€"
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Meow! Let's compile that kernel! ğŸ˜º
          EOF

      # Step 2: Install Dependencies
      - name: ğŸ› ï¸ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing build dependencies..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Installing dependencies... ğŸ› ï¸
          EOF
          # Enable 32-bit architecture support for arm32 dependencies
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y build-essential device-tree-compiler ninja-build \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf libsepol-dev \
            lib32z1-dev lib32ncurses-dev lib32gcc-11-dev \
            bc bison flex libssl-dev python3 zip curl
          echo "âœ… Dependencies installed successfully!"

      # Step 3: Setup ccache
      - name: âš¡ Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 5G
        run: |
          echo "âš¡ Setting up ccache for faster compilation..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Caching like a pro! âš¡
          EOF

      # Step 4: Download LLVM Clang
      - name: ğŸ“¥ Download LLVM Clang
        run: |
          echo "ğŸ“¥ Downloading LLVM Clang 21.1.0-rc1..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Fetching LLVM Clang... ğŸ“¥
          EOF
          curl -LSs https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.0-rc1/LLVM-21.1.0-rc1-Linux-X64.tar.xz -o llvm.tar.xz
          tar -xvf llvm.tar.xz
          mv LLVM-21.1.0-rc1-Linux-X64 llvm
          echo "âœ… LLVM Clang downloaded and extracted!"

      # Step 5: Set Environment Variables
      - name: ğŸŒ Set Environment Variables
        run: |
          echo "ğŸŒ Configuring environment variables..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Setting up the environment... ğŸŒ
          EOF
          echo "PATH=$(pwd)/llvm/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabihf-" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=MINHAZ" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=POTATO" >> $GITHUB_ENV
          echo "âœ… Environment variables set!"

      # Step 6: Verify Toolchain Setup
      - name: ğŸ” Verify Toolchain Setup
        run: |
          echo "ğŸ” Verifying toolchain setup..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Checking the toolchain... ğŸ”
          EOF
          clang --version
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabihf-gcc --version
          ccache --version
          echo "âœ… Toolchain verified!"

      # Step 7: Checkout Kernel Source
      - name: ğŸ“š Checkout Kernel Source
        run: |
          echo "ğŸ“š Cloning kernel source..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Fetching kernel source... ğŸ“š
          EOF
          git clone --depth 1 https://github.com/xiaomi-sm6250-devs/android_kernel_xiaomi_sm6250 -b lineage-22.2 kernel
          echo "âœ… Kernel source cloned!"

      # Step 8: Clean Kernel Source
      - name: ğŸ§¹ Clean Kernel Source
        run: |
          echo "ğŸ§¹ Cleaning kernel source..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Cleaning up with mrproper... ğŸ§¹
          EOF
          cd kernel
          make mrproper
          make clean
          echo "âœ… Kernel source cleaned!"

      # Step 9: Generate Defconfig
      - name: âš™ï¸ Generate Defconfig
        run: |
          echo "âš™ï¸ Generating defconfig..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Setting up defconfig... âš™ï¸
          EOF
          cd kernel
          make O=out vendor/xiaomi/miatoll_defconfig
          echo "âœ… Defconfig generated!"

      # Step 10: Compile Kernel
      - name: ğŸ”¥ Compile Kernel
        run: |
          echo "ğŸ”¥ Compiling kernel..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Building the kernel... ğŸ”¥
          EOF
          cd kernel
          make O=out \
            ARCH=arm64 \
            SUBARCH=arm64 \
            CC="ccache clang" \
            CXX="ccache clang++" \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabihf- \
            -j$(nproc)
          echo "âœ… Kernel compiled successfully!"

      # Step 11: Checkout AnyKernel3
      - name: ğŸ“¦ Checkout AnyKernel3
        run: |
          echo "ğŸ“¦ Cloning AnyKernel3..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Fetching AnyKernel3... ğŸ“¦
          EOF
          git clone --depth 1 https://github.com/ImONE-Na/AnyKernel3 -b master AnyKernel3
          echo "âœ… AnyKernel3 cloned!"

      # Step 12: Prepare AnyKernel3
      - name: ğŸ› ï¸ Prepare AnyKernel3
        run: |
          echo "ğŸ› ï¸ Preparing AnyKernel3..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Setting up AnyKernel3... ğŸ› ï¸
          EOF
          cd AnyKernel3
          # Copy kernel image and other files
          cp ../kernel/out/arch/arm64/boot/Image.gz anykernel3/
          cp ../kernel/out/arch/arm64/boot/dtbo.img anykernel3/
          cp ../kernel/out/arch/arm64/boot/dtb.img anykernel3/
          find ../kernel/out -name '*.ko' -exec cp {} anykernel3/modules/system/lib/modules/ \;
          # Update anykernel.sh
          sed -i 's@kernel.string=.*@kernel.string=Lineage Kernel@' anykernel3/anykernel.sh
          sed -i 's@kernel.compiler=.*@kernel.compiler=LLVM Clang 21.1.0-rc1@' anykernel3/anykernel.sh
          sed -i 's@kernel.version=.*@kernel.version=4.14.336@' anykernel3/anykernel.sh
          echo "âœ… AnyKernel3 prepared!"

      # Step 13: Create Flashable ZIP
      - name: ğŸ“¦ Create Flashable ZIP
        run: |
          echo "ğŸ“¦ Creating flashable ZIP..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Zipping up the kernel... ğŸ“¦
          EOF
          cd AnyKernel3
          zip -r9 LineageKernel-Curtana.zip .
          echo "âœ… Flashable ZIP created!"

      # Step 14: Upload Artifact
      - name: ğŸ“¤ Upload Flashable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: LineageKernel-Curtana
          path: AnyKernel3/LineageKernel-Curtana.zip
        run: |
          echo "ğŸ“¤ Uploading flashable ZIP..."
          cat << EOF
          /_/\  
         ( o.o ) 
          > ^ <
          Uploading the kernel ZIP... ğŸ“¤
          EOF
          echo "âœ… Artifact uploaded!"
