name: 'Lineage kernel Compilation 🐧'

#
# 🚀 Workflow Triggers
#
# This workflow will automatically start when you push new commits to the 'main' branch.
#
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows you to manually trigger the workflow from the GitHub Actions tab

jobs:
  build:
    name: '🏗️ Kernel Building ...'
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------------------------------
      # 🛠️ 1. Initial Setup & Checkout
      # ----------------------------------------------------------------------------------------
      - name: '📦 Initializing The Build Environment'
        uses: actions/checkout@v4

      - name: '🔧 Installing Dependencies'
        run: |
          echo " "
          echo "  ██████╗ ██╗███╗    ██╗████████╗ █████╗ ██╗      ██╗    ██╗██╗    ██╗███████╗"
          echo "  ██╔══██╗██║████╗  ██║╚══██╔══╝██╔══██╗██║      ██║    ██║██║    ██║██╔════╝"
          echo "  ██████╔╝██║██╔██╗ ██║  ██║  ███████║██║      ██║    ██║██║    ██║█████╗"
          echo "  ██╔══██╗██║██║╚██╗██║  ██║  ██╔══██║██║      ╚██╗ ██╔╝██║    ██║██╔══╝"
          echo "  ██║  ██║██║██║ ╚████║  ██║  ██║  ██║███████╗ ╚████╔╝ ╚██████╔╝███████╗"
          echo "  ╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝  ╚═╝  ╚═╝  ╚═╝╚══════╝  ╚═══╝  ╚═════╝ ╚══════╝"
          echo " "
          sudo dpkg --add-architecture i386 # Add i386 architecture
          sudo apt-get update
          sudo apt-get install -y bc build-essential ccache curl device-tree-compiler \
                                   flex g++-multilib gcc-multilib git gnupg gperf imagemagick \
                                   lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev \
                                   liblz4-tool libncurses5-dev libsdl1.2-dev libsepol-dev libssl-dev \
                                   libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
                                   xsltproc zip zlib1g-dev ninja-build gcc-aarch64-linux-gnu \
                                   gcc-arm-linux-gnueabi binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi

      # ----------------------------------------------------------------------------------------
      # ⚡ 2. Ccache for Faster Builds
      # ----------------------------------------------------------------------------------------
      - name: '⚡ Setting Up Build Cache'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: 5G # Set cache size to 5GB

      # ----------------------------------------------------------------------------------------
      # 📥 3. Cloning All Necessary Repositories
      # ----------------------------------------------------------------------------------------
      - name: '📥 Cloning Kernel Source'
        run: |
          echo " "
          echo "  _  __ _   _    _          _     "
          echo " | |/ /(_) | |  | |   ___   ___ | | _____ "
          echo " | ' /  _  | |  | | / _ \ / __|| |/ / __|"
          echo " |  <  | | | |/\| | / _ \ / __|| |/ / __|"
          echo " | . \ | | \  /\  /|  __/| (__ |   <\__ \"
          echo " |_|\_\|_|  \/  \/  \___| \___||_|\_\___/"
          echo " "
          git clone --depth=1 https://github.com/xiaomi-sm6250-devs/android_kernel_xiaomi_sm6250 -b lineage-22.2 $GITHUB_WORKSPACE/kernel

      - name: '📥 Cloning AOSP Clang Compiler'
        run: |
          echo " "
          echo "      /\    ____   ___   ____    _   _   ____    _   "
          echo "     /  \  / __ \ / _ \ / __ \  | \ | | / __ \  / \   "
          echo "    / /\ \ | | | || | | || | | | |  \| || |  | |/ _ \  "
          echo "   / ____ \| | | || | | || | | | | .  || |  | |/ ___ \ "
          echo "  /_/    \\_\ \_\\ \_\\ \_\\ | |\  |\_\ \_\\_\\ "
          echo "/_/    \\____/ \___/ \____/ |_| \_| \____//_/    \\_\\"
          echo " "
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/clang-r547379 $GITHUB_WORKSPACE/clang

      - name: '📥 Cloning AnyKernel3'
        run: |
          echo " "
          echo "      _   _ _   _ _ _ ____ ____ _ _ "
          echo "     / \  / \/ \ / \/ \/ \/  __\/  _ \/ \/ \\"
          echo "     | |  | || || || || |||  \/|| / \|| || |"
          echo "     | |_/\| || || || || |||    || \_/|| || |"
          echo "     \____/\_/\_/\_/\_/\_/\_/\_/ \____/\_/\_/"
          echo " "
          git clone --depth=1 https://github.com/ImONE-Na/AnyKernel3 -b master $GITHUB_WORKSPACE/AnyKernel3

      # ----------------------------------------------------------------------------------------
      # ⚙️ 4. Setting Up The Build Environment
      # ----------------------------------------------------------------------------------------
      - name: '⚙️ Setting Up Environment Variables'
        run: |
          echo " "
          echo "  ______    __  __    __  __    ______    ______    ______      ______    __    __ "
          echo " /\ ___\ /\ \_\ \   /\ \/\ \   /\ __ \   /\__ _\ /\ __ \   /\ == \   /\ '-./  \""
          echo " \ \ __\ \ \  __ \  \ \ \_\ \  \ \ \/\ \  \/_/\ \/ \ \ \/\ \  \ \ __<   \ \ \-./\ \ "
          echo "  \ \_____\\ \_\ \_\  \ \_____\  \ \_____\    \ \_\  \ \_____\  \ \_\ \_\  \ \_\ \ \_\"
          echo "   \/_____/ \/_/\/_/   \/_____/   \/_____/     \/_/   \/_____/   \/_/ /_/   \/_/  \/_/"
          echo " "
          # Set build user and host
          echo "KBUILD_BUILD_USER=MINHAZ" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=POTATO" >> $GITHUB_ENV

          # Set Clang path
          echo "CLANG_PATH=$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/clang/bin:$PATH" >> $GITHUB_ENV

          # Set cross compile variables
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV

      # ----------------------------------------------------------------------------------------
      # 🧹 5. Cleaning The Kernel Source Tree
      # ----------------------------------------------------------------------------------------
      - name: '🧹 Cleaning Kernel Source'
        run: |
          echo " "
          echo "    _____ _     _____          _     "
          echo "  / ____| |   / ____|        (_)     "
          echo " | |    | |  | (___   ___ _ __ _ _ __  "
          echo " | |    | |   \___ \ / __| '__| | '_ \ "
          echo " | |____| |________) | (__| |  | | |_) |"
          echo "  \_____|______|_____/ \___|_|  |_| .__/ "
          echo "                                 | |   "
          echo "                                 |_|   "
          echo " "
          cd $GITHUB_WORKSPACE/kernel
          make mrproper
          make clean

      # ----------------------------------------------------------------------------------------
      # 🛠️ 6. Compiling The Kernel
      # ----------------------------------------------------------------------------------------
      - name: '🛠️ Compiling The Kernel'
        run: |
          echo " "
          echo "    _____                      _ _       "
          echo "  / ____|                    | (_)       "
          echo " | |   ___ _ __ ___ _ __  _   _| |_ ___ _ __ "
          echo " | |  / _ \| '_ \` _ \| '_ \| | | | | / __| '__|"
          echo " | |___| (_) | | | | | |_) | |_| | | \__ \ |   "
          echo "  \_____\___/|_| |_| |_| .__/ \__,_|_|_|___/_|   "
          echo "                       | |                     "
          echo "                       |_|                     "
          echo " "
          cd $GITHUB_WORKSPACE/kernel
          # Configure the kernel
          make O=out vendor/xiaomi/miatoll_defconfig

          # Start the compilation
          make -j$(nproc --all) O=out \
                CC="ccache clang" \
                CXX="ccache clang++" \
                CLANG_TRIPLE="aarch64-linux-gnu-" \
                CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
                CROSS_COMPILE_ARM32=${{ env.CROSS_COMPILE_ARM32 }} \
                ARCH=${{ env.ARCH }} \
                SUBARCH=${{ env.SUBARCH }}

      # ----------------------------------------------------------------------------------------
      # 📦 7. Packaging into a Flashable Zip
      # ----------------------------------------------------------------------------------------
      - name: '📦 Packaging Flashable Zip'
        run: |
          echo " "
          echo "  ____           _              ______ _ _     "
          echo " |  _ \         | |            | ____(_) |     "
          echo " | |_) | __ _ ___| | _____ _ __ ___ | |__   _| | ___ "
          echo " |  _ < / _\` |/ __| |/ / _ \ '__/ __| |  __| | | |/ _ \\"
          echo " | |_) | (_| | (__|   <  __/ |  \__ \ | |    | | |  __/"
          echo " |____/ \__,_|\___|_|\_\___|_|  |___/ |_|    |_|_|\___|"
          echo " "
          # Copy kernel images and modules
          cp $GITHUB_WORKSPACE/kernel/out/arch/arm64/boot/Image.gz $GITHUB_WORKSPACE/AnyKernel3/
          cp $GITHUB_WORKSPACE/kernel/out/arch/arm64/boot/dtb.img $GITHUB_WORKSPACE/AnyKernel3/
          cp $GITHUB_WORKSPACE/kernel/out/arch/arm64/boot/dtbo.img $GITHUB_WORKSPACE/AnyKernel3/
          find $GITHUB_WORKSPACE/kernel/out/ -name "*.ko" -exec cp {} $GITHUB_WORKSPACE/AnyKernel3/modules/ \;

          # Modify AnyKernel.sh
          cd $GITHUB_WORKSPACE/AnyKernel3
          CLANG_VERSION=$(${{ env.CLANG_PATH }}/clang --version | head -n 1)
          sed -i 's@kernel.string=.*@kernel.string="Lineage Kernel by MINHAZ"@' anykernel.sh
          sed -i "s@kernel.compiler=.*@kernel.compiler=\"${CLANG_VERSION}\"@" anykernel.sh
          sed -i 's@kernel.version=.*@kernel.version=4.14.336@' anykernel.sh

          # Create the zip
          zip -r9 Lineage-Kernel-curtana.zip * -x .git README.md *placeholder

      # ----------------------------------------------------------------------------------------
      # 📤 8. Uploading The Artifact
      # ----------------------------------------------------------------------------------------
      - name: '📤 Uploading Kernel Zip'
        uses: actions/upload-artifact@v4
        with:
          name: Lineage-Kernel-curtana
          path: $GITHUB_WORKSPACE/AnyKernel3/Lineage-Kernel-curtana.zip
