#
# â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘
# â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘ â•šâ•â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•
# â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•—
# â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•    â•šâ•â•  â•šâ•â•    â•šâ•â•  â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•
#
# This workflow is designed to build the LineageOS kernel for 'curtana'.
# Created with â¤ï¸ by Gemini for MINHAZ.
#

name: ğŸ—ï¸ Lineage Kernel Compilation

# â–¶ï¸ Controls when the workflow will run
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    name: ğŸ—ï¸ Kernel Building ...
    runs-on: ubuntu-latest

    steps:
      # ğŸ± ASCII Cat Welcome
      - name: ğŸ¾ Welcome Message
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

              /\_/\
            ( o.o )
              > ^ <
            /  |  \
          /    |    \
          /    |    \
          /_____|_____\

          Starting the LineageOS Kernel Build! Let's get this done! ğŸš€

          EOF

      # ì…‹ì—… Checking out the repository
      - name: â¬‡ï¸ Checking out repository
        uses: actions/checkout@v4

      # âš¡ï¸ Speeding up the process with ccache
      - name: ğŸ—„ï¸ Caching build dependencies
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ github.job }}
          max-size: 5G # Setting cache size to 5GB

      # ğŸ“¦ Installing all the necessary dependencies
      - name: ğŸ”§ Installing Build Dependencies
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          export DEBIAN_FRONTEND=noninteractive # Set non-interactive frontend for apt
          sudo dpkg --add-architecture i386
          echo "âœ… Enabled i386 architecture."
          sudo apt-get update -y
          echo "âœ… Apt package lists updated."
          sudo apt-get install -y --no-install-recommends \
            build-essential git curl wget ccache libsepol-dev device-tree-compiler \
            ninja-build crossbuild-essential-arm64 crossbuild-essential-armhf \
            libncurses5-dev libssl-dev libelf-dev bc rsync \
            lsb-core libstdc++6:i386 libgcc1:i386 zlib1g:i386 libncurses5:i386
          echo "âœ… All necessary dependencies are installed successfully! ğŸ‰"

      # ğŸ“¥ Downloading the LLVM Clang toolchain
      - name: ğŸ› ï¸ Downloading LLVM Clang Toolchain
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |  Downloading LLVM Clang Toolchain  |
            +----------------------------------+

          EOF
          echo "â³ Downloading LLVM Clang... this might take a moment."
          # Note: This is an RC (Release Candidate) version. For production, consider a stable release.
          curl -LSs "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.0-rc1/LLVM-21.1.0-rc1-Linux-X64.tar.xz" -o llvm.tar.xz
          mkdir llvm
          tar -xf llvm.tar.xz -C llvm --strip-components=1
          rm llvm.tar.xz
          echo "âœ… LLVM Clang downloaded and extracted successfully!"

      # ğŸŒ Setting up the build environment
      - name: âš™ï¸ Setting Up Build Environment
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |    Setting Environment Variables   |
            +----------------------------------+

          EOF
          echo "export KBUILD_BUILD_USER=\"MINHAZ\"" >> $GITHUB_ENV
          echo "export KBUILD_BUILD_HOST=\"POTATO\"" >> $GITHUB_ENV
          echo "export LLVM_HOME=\"${{ github.workspace }}/llvm\"" >> $GITHUB_ENV
          echo "export PATH=\"${{ github.workspace }}/llvm/bin:$PATH\"" >> $GITHUB_ENV
          echo "export ARCH=arm64" >> $GITHUB_ENV
          echo "export SUBARCH=arm64" >> $GITHUB_ENV
          echo "export CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "export CROSS_COMPILE_ARM32=arm-linux-gnueabihf-" >> $GITHUB_ENV
          echo "export CC=\"ccache clang\"" >> $GITHUB_ENV
          echo "export CXX=\"ccache clang++\"" >> $GITHUB_ENV
          echo "export LLVM=1" >> $GITHUB_ENV
          echo "export LLVM_IAS=1" >> $GITHUB_ENV
          echo "âœ… Environment variables are set and ready to go!"

      # ğŸŒ³ Cloning the kernel source code
      - name: ğŸŒ² Cloning Kernel Source
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

              /\
            /\*\
            /\O\*\
            /\/\/\/\

            Cloning the kernel source...

          EOF
          git clone --depth=1 https://github.com/xiaomi-sm6250-devs/android_kernel_xiaomi_sm6250 -b lineage-22.2 kernel
          echo "âœ… Kernel source cloned successfully!"

      # ğŸ§¹ Cleaning up the source tree
      - name: ğŸ§¼ Cleaning Kernel Source
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |      Cleaning Source Tree        |
            +----------------------------------+

          EOF
          cd kernel
          make O=out mrproper
          make O=out clean
          echo "âœ… Kernel source tree is now clean as a whistle!"

      # âš™ï¸ Configuring the kernel build
      - name: ğŸ“ Configuring Kernel
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |      Configuring the Kernel      |
            +----------------------------------+

          EOF
          cd kernel
          make O=out vendor/xiaomi/miatoll_defconfig
          echo "âœ… Kernel configuration is set for miatoll!"

      # ğŸš€ Compiling the kernel
      - name: ğŸ”¥ Compiling The Kernel
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |        Starting Compilation      |
            +----------------------------------+

          EOF
          cd kernel
          echo "ğŸš€ Let the compilation begin! This is the exciting part!"
          make O=out -j$(nproc --all)
          echo "âœ… Kernel compilation finished successfully! What a beast! ğŸ’ª"

      # ğŸ“¦ Cloning AnyKernel3 for packaging
      - name: ğŸ Cloning AnyKernel3
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |      Cloning AnyKernel3        |
            +----------------------------------+

          EOF
          git clone --depth=1 https://github.com/ImONE-Na/AnyKernel3 -b master anykernel
          echo "âœ… AnyKernel3 repository cloned."

      # ğŸ Packaging the flashable zip
      - name: ğŸ“¦ Packaging Flashable Zip
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          cat << "EOF"

            +----------------------------------+
            |      Packaging the Final Zip     |
            +----------------------------------+

          EOF
          cd anykernel
          # Copy kernel artifacts
          # For miatoll, Image.gz-dtb is the common output for combined kernel+dtb
          cp ../kernel/out/arch/arm64/boot/Image.gz-dtb .
          # Copy dtb.img and dtbo.img if they are generated separately and needed by AnyKernel3
          # Note: If Image.gz-dtb already contains the DTB, dtb.img might be redundant.
          cp ../kernel/out/arch/arm64/boot/dtb.img . || true # Use || true to prevent failure if not found
          cp ../kernel/out/arch/arm64/boot/dtbo.img . || true # Use || true to prevent failure if not found
          # Copy modules
          find ../kernel/out -name "*.ko" -exec cp {} modules/vendor/lib/modules/ \;

          # Get compiler version
          COMPILER_VERSION=$(clang --version | head -n 1)

          # Update anykernel.sh
          sed -i "s@kernel.string=.*@kernel.string=\"Lineage Kernel by MINHAZ\"@" anykernel.sh
          sed -i "s@kernel.compiler=.*@kernel.compiler=\"${COMPILER_VERSION}\"@" anykernel.sh
          sed -i "s@kernel.version=.*@kernel.version=4.14.336@" anykernel.sh
          echo "âœ… anykernel.sh updated."

          # Zip it up!
          zip -r9 Lineage-Kernel-curtana-$(date +%Y%m%d).zip * -x .git*
          echo "âœ… Flashable zip created successfully!"

      # ğŸ“¤ Uploading the final artifact
      - name: ğŸ“¤ Uploading Kernel Zip
        uses: actions/upload-artifact@v4
        with:
          name: Lineage-Kernel-curtana
          path: anykernel/Lineage-Kernel-curtana-*.zip
